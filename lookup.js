/**
 * 有道词典划词扩展 V3 - 可记录、导出查询历史的有道词典划词扩展
 * @version v3.2.4.1
 * @author g8up
 */
"use strict";function isChinese(e){return!/[^\u4e00-\u9fa5]/.test(e)}function isJapanese(e){return!/[^\u0800-\u4e00]/.test(e)}function isKoera(e){for(var t=0,n=e.length;t<n;t++)if(e.charCodeAt(t)>12592&&e.charCodeAt(t)<12687||e.charCodeAt(t)>=44032&&e.charCodeAt(t)<=55203)return!0;return!1}function isContainChinese(e){for(var t=0,n=0,o=e.length;n<o;n++)isChinese(e.charAt(n))&&t++;return t>5}function isContainJapanese(e){for(var t=0,n=0,o=e.length;n<o;n++)isJapanese(e.charAt(n))&&t++;return t>2}function isContainKoera(e){for(var t=0,n=0,o=e.length;n<o;n++)isKoera(e.charAt(n))&&t++;return t>0}function isAlpha(e){return/[a-zA-Z']+/.test(e)}function spaceCount(e){for(var t=0,n=0;n<e.length;n++)" "==e.charAt(n)&&t++;return t}function ExtractEnglish(e){var t=new RegExp(/([a-zA-Z ]+)/).exec(e);return t&&t.length?t[1]:""}function playAudio(e){chrome.runtime.sendMessage({action:"speech",word:e},function(){})}function addToNote(e,t){chrome.runtime.sendMessage({action:"youdao-add-word",word:e},function(e){t&&t(e)})}var last_frame,debounce=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200,n=null;return function(){for(var o=arguments.length,a=Array(o),r=0;r<o;r++)a[r]=arguments[r];clearTimeout(n),n=setTimeout(function(){e.apply(null,a)},t)}},Options={},body=document.body,last_time=0;function getOption(e){chrome.runtime.sendMessage({action:"getOption"},function(t){t&&t.option&&(Object.assign(Options,t.option),dealSelectEvent(),dealPointEvent()),e&&e()})}function getOptVal(e){if(null!==Options)return Options[e][1]}getOption();var prevC,prevO,onSelectToTrans=debounce(function(e){var t=window.getSelection().toString().trim();if(!(t.length<1||t.length>2e3)){var n=e.pageX,o=e.pageY,a=e.screenX,r=e.screenY,i=isContainJapanese(t),c=isContainChinese(t);if(getOptVal("english_only")){var s=isContainKoera(t);if(i||c||s)return;""!==(t=ExtractEnglish(t))&&getYoudaoDict(t,function(e){createPopUpEx(e,n,o,a,r)})}else(!c&&spaceCount(t)>=3||c&&t.length>4||i&&t.length>4)&&getYoudaoTrans(t,function(e){createPopUpEx(e,n,o,a,r)})}});function dealSelectEvent(){getOptVal("dict_enable")?(body.removeEventListener("mouseup",onSelectToTrans),body.addEventListener("mouseup",onSelectToTrans)):body.removeEventListener("mouseup",onSelectToTrans)}var onPointToTrans=debounce(function(e){if(e.ctrlKey&&!e.shiftKey&&!e.altKey){var t=document.caretRangeFromPoint(e.clientX,e.clientY);if(!t)return!0;var n=t.startOffset,o=t.endOffset;if(prevC===t.startContainer&&prevO===n)return!0;prevC=t.startContainer,prevO=n;var a=t.cloneRange(),r="";if(t.startContainer.data)for(;n>=1;)if(a.setStart(t.startContainer,--n),!isAlpha((r=a.toString()).charAt(0))){a.setStart(t.startContainer,n+1);break}if(t.endContainer.data)for(;o<t.endContainer.data.length;)if(a.setEnd(t.endContainer,++o),!isAlpha((r=a.toString()).charAt(r.length-1))){a.setEnd(t.endContainer,o-1);break}var i=a.toString();if(i.length>=1){var c=e.pageX,s=e.pageY,d=e.screenX,l=e.screenY,u=window.getSelection();u.removeAllRanges(),u.addRange(a),getYoudaoDict(i,function(e){createPopUpEx(e,c,s,d,l)})}}});function dealPointEvent(){getOptVal("ctrl_only")?(document.removeEventListener("mousemove",onPointToTrans),document.addEventListener("mousemove",onPointToTrans)):document.removeEventListener("mousemove",onPointToTrans)}function OnCheckCloseWindow(){if(last_frame){if((new Date).getTime()-last_time<500)return;closePanel(),last_frame=null}}function closePanel(){content&&(content.classList.remove("fadeIn"),content.innerHTML="")}function createPopUpEx(e,t,n,o,a){if(void 0!==e){var r=window.getSelection();r&&r.rangeCount&&createPopUp(e,r.getRangeAt(0).startContainer.nodeValue,t,n,o,a)}}function createPopUp(e,t,n,o,a,r){var i=0,c=0,s=getYoudaoDictPanelCont(e);body.style.position="static";var d=screen.availWidth,l=screen.availHeight;if(i=a+300<d?n:n-300-20,s.style.left=i+"px",c=r+150+20<l?o:o-150-20,s.style.top=c+10+"px",s.style.left+300>d&&(s.style.left-=s.style.left+300-d),c+10+s.clientHeight<o){var u=o-s.clientHeight;s.style.top=u+"px"}s.style.display="",last_time=(new Date).getTime(),last_frame=s}document.addEventListener("click",OnCheckCloseWindow);var content=null,getYoudaoDictPanelCont=function(e){var t=document.querySelector("div#yddWrapper");if(!t){(t=document.createElement("div")).id="yddWrapper",t.style.display="none",markTagOrigin(t),body.appendChild(t),addPanelEvent(t);var n=genTmpl(),o=t.createShadowRoot();o.appendChild(document.importNode(n.content,!0)),content=o.querySelector("#ydd-content")}return content.innerHTML=e,content.classList.add("fadeIn"),addContentEvent(content),t};function addPanelEvent(e){var t,n;e.setAttribute("draggable",!0),e.ondragstart=function(o){t=o.x-parseInt(e.style.left),n=o.y-parseInt(e.style.top)},e.ondragend=function(o){e.style.left=o.x-t+"px",e.style.top=o.y-n+"px",t=0,n=0}}var addContentEvent=function(e){e.addEventListener("click",function(e){e.stopPropagation()}),e.addEventListener("mouseup",function(e){e.stopPropagation()});var t=e.querySelector(".ydd-close");t.onclick=function(e){closePanel()},t=null,function(){var t=e.querySelector(".ydd-voice");if(t){if(""!=t.innerHTML){t.classList.add("ydd-voice-icon");var n=t.textContent;getOptVal("auto_speech")&&playAudio(n),t.addEventListener("click",function(e){playAudio(n)})}t.innerHTML=""}}();var n=e.querySelector("#addToNote");n.addEventListener("click",function(t){t.preventDefault();var o=e.querySelector(".yddKeyTitle").textContent.trim();o&&addToNote(o,function(){n.classList.add("green")})})};function getYoudaoDict(e,t){chrome.runtime.sendMessage({action:"dict",word:e},function(e){t&&t(e)})}function getYoudaoTrans(e,t){chrome.runtime.sendMessage({action:"translate",word:e},function(e){t&&t(e)})}chrome.runtime.onMessage.addListener(function(e,t,n){e.optionChanged&&(Object.assign(Options,e.optionChanged),dealSelectEvent(),dealPointEvent())});var genTmpl=function(){var e=document.querySelector("template#youdaoDictPanel");if(e)return e;(e=document.createElement("template")).id="youdaoDictPanel",markTagOrigin(e);var t=chrome.extension.getURL("youdao-crx.css");return e.innerHTML='<style>@import "'+t+'"; </style><div id="ydd-content"></div>',body.appendChild(e),e};function markTagOrigin(e){e&&e.setAttribute("data-comment","这是有道词典 “Chrome 划词扩展 V3” 插入的节点")}
