/**
 * 有道词典划词扩展 V3 - 可记录、导出查询历史的有道词典划词扩展
 * @version v3.2.4.1
 * @author g8up
 */
"use strict";const set=(e,n)=>new Promise((t,o)=>{chrome.storage.sync.set({[e]:n},()=>{t()})}).catch(e=>{console.warn(e)}),get=e=>new Promise((n,t)=>{chrome.storage.sync.get(e,e=>{n(e)})}).catch(e=>{console.warn(e)});var chromeSync={set:set,get:get};class Storage{constructor(e,n){this.name=e,this.defaultValue=n}}var OPTION_STORAGE_ITEM="Setting";const DEFAULT={dict_enable:["checked",!1],ctrl_only:["checked",!0],english_only:["checked",!0],auto_speech:["checked",!0],history_count:5};class Setting extends Storage{constructor(){super(OPTION_STORAGE_ITEM,DEFAULT)}get(){return chromeSync.get(this.name).then(e=>{let n=this.defaultValue;return e&&Object.keys(e).length>0&&(n=e[this.name]),n})}set(e){return chromeSync.set(this.name,e)}}function isJapanese(e){return!/[^\u0800-\u4e00]/.test(e)}function isKoera(e){for(var n=0,t=e.length;n<t;n++)if(e.charCodeAt(n)>12592&&e.charCodeAt(n)<12687||e.charCodeAt(n)>=44032&&e.charCodeAt(n)<=55203)return!0;return!1}function isContainJapanese(e){for(var n=0,t=0,o=e.length;t<o;t++)isJapanese(e.charAt(t))&&n++;return n>2}function isContainKoera(e){for(var n=0,t=0,o=e.length;t<o;t++)isKoera(e.charAt(t))&&n++;return n>0}function playAudio(e){chrome.runtime.sendMessage({action:"speech",word:e},function(){})}function addToNote(e,n){chrome.runtime.sendMessage({action:"youdao-add-word",word:e},function(e){n&&n(e)})}function queryString(e){return e?Object.keys(e).map(function(n){return[encodeURIComponent(n),encodeURIComponent(e[n])].join("=")}).join("&"):""}function qs(e){return Object.keys(e).map(function(n){return n+"="+encodeURIComponent(e[n])}).join("&")}var _word,noop=function(){},ajax=function(e){var n=e.url,t=e.type||"GET",o=(e.dataType||"").toLowerCase(),a=e.data,r=e.success||noop,s=(e.error,new XMLHttpRequest);s.onreadystatechange=function(e){if(4==s.readyState&&200==s.status){var n=s.responseText;"json"===o||"xml"===o&&(n=s.responseXML),r(n)}};var c=qs(a);"GET"===t&&(n+="?"+c),s.open(t,n,!0),s.send("GET"===t?null:c)},Options=null,retphrase="",noBaseTrans=!1,noWebTrans=!1,langType="",setting=new Setting;function translateXML(e){var n="",t="",o=e.getElementsByTagName("yodaodict")[0],a=o.getElementsByTagName("return-phrase");""+a[0].childNodes[0]!="undefined"&&(retphrase=a[0].childNodes[0].nodeValue),""+o.getElementsByTagName("lang")[0]!="undefined"&&(langType=o.getElementsByTagName("lang")[0].childNodes[0].nodeValue);var r=o.getElementsByTagName("phonetic-symbol")[0];if(""+r!="undefined"&&""+r.childNodes[0]!="undefined")r.childNodes[0].nodeValue;var s=o.getElementsByTagName("translation")[0];if(""+s=="undefined"&&(noBaseTrans=!0),""+o.getElementsByTagName("web-translation")[0]=="undefined"&&(noWebTrans=!0),!1===noBaseTrans)if(""+s.childNodes[0]!="undefined")for(var c=o.getElementsByTagName("translation"),i=0;i<c.length;i++){var d=c[i].getElementsByTagName("content")[0].childNodes[0].nodeValue+"<br/>";if(d.length>50){d=d.split(/[;；]/).join("<br/>")}n+=d}else n+="未找到基本释义";if(!1===noWebTrans){if(""+o.getElementsByTagName("web-translation")[0].childNodes[0]!="undefined")var l=o.getElementsByTagName("web-translation");else t+="未找到网络释义";for(i=0;i<l.length;i++)t+=l[i].getElementsByTagName("key")[0].childNodes[0].nodeValue+":  ",t+=l[i].getElementsByTagName("trans")[0].getElementsByTagName("value")[0].childNodes[0].nodeValue+"<br/>"}buildSearchResult({basetrans:n,webtrans:t})}function mainQuery(e,n){""!==e&&(_word=e.trim(),ajax({url:"http://dict.youdao.com/fsearch",dataType:"xml",data:{client:"deskdict",keyfrom:"chrome.extension.g8up",q:_word,pos:-1,doctype:"xml",xmlVersion:"3.2",dogVersion:"1.0",vendor:"g8up",appVer:"3.1.17.4208",le:"eng"},success:function(e){var t=translateXML(e);null!=t&&n(t)}}))}function buildSearchResult(e){var n=e.basetrans,t=e.webtrans;document.querySelector("#options").style.display="none";var o={q:_word,ue:"utf8",keyfrom:"chrome.extension"};isContainKoera(_word)&&(o.le="ko"),isContainJapanese(_word)&&(o.le="jap"),"fr"==langType&&(o.le="fr");var a=document.getElementById("result");if(a.innerHTML="",0==noBaseTrans){a.innerHTML="<strong>"+({ko:"韩汉",jap:"日汉",fr:"法汉"}[langType]||"英汉")+"翻译:</strong><span class='word-speech' data-toggle='play'></span> <a href='#' class='add-to-note' data-toggle='addToNote'>+</a><br/>"+n}if(0==noWebTrans&&(a.innerHTML+="<strong>网络释义:</strong><br/>"+t),0==noBaseTrans||0==noWebTrans){var r=getLink("http://dict.youdao.com/search",o);a.innerHTML+='<a class="weblink" href="'+r+'" target="_blank">点击 查看详细释义</a>'}noBaseTrans&&noWebTrans?a.innerHTML='未找到英汉翻译!<br><a class="weblink" href="http://www.youdao.com/w/'+encodeURIComponent(_word)+'" target="_blank">尝试用有道搜索</a>':saveSearchedWord(),getCachedWord(),retphrase="",langType="",noBaseTrans=!1,noWebTrans=!1}function getCachedWord(){var e=[];if((r=localStorage.getItem("wordcache"))&&(r=r.trim())){for(var n=Options.history_count>=0?Options.history_count:0,t=r.split(",",n),o=0,a=t.length;o<a;o++)e.push("<a>"+t[o]+"</a>");if(e.length){var r=document.querySelector("#cache");e.unshift("<strong>查询历史：</strong>"),r.innerHTML=e.join("<br/>"),r.onclick=function(e){var n=(e||window.event).target;if("a"==n.tagName.toLowerCase()){var t=n.innerText;t&&(document.querySelector("#word").value=t,mainQuery(t,translateXML))}},r=null}}}function saveSearchedWord(e){var n=e||(document.querySelector("#word")?document.querySelector("#word").value:"");if(n&&(n=n.trim())){var t=localStorage.getItem("wordcache");if(t){if(t.indexOf(n)>-1)return;t=[n,t].join()}else t=n;localStorage.setItem("wordcache",t)}}function changeIcon(){var e=document.getElementById("english_only"),n=document.getElementById("dict_enable").checked;e.disabled=!n}function getLink(e,n){return e+"?"+queryString(n)}function restoreOptions(e){for(var n in e){var t=document.getElementById(n);if(t){var o=e[n];if(!o)continue;switch(t.getAttribute("type")){case"checkbox":"checked"==o[0]&&(t.checked=o[1]);break;case"number":t.value=o||e.history_count}}}}var exportHistory=function(){var e=localStorage.getItem("wordcache");if(e){var n=chrome.app.getDetails(),t="\r\n";saveContent2File(""+["【"+n.name+"】V"+n.version+" 查询历史备份文件",""+(new Date).toString().slice(0,24),"By https://chrome.google.com/webstore/detail/chgkpfgnhlojjpjchjcbpbgmdnmfmmil",""+new Array(25).join("=")].join(t).trim()+t+e.replace(/\,/g,t),"youDaoCrx-history "+ +new Date+".txt")}};function saveContent2File(e,n){var t=new Blob([e],{type:"text/plain;charset=utf-8"});saveAs(t,n)}function saveOptions(){for(var e in Options){var n=document.getElementById(e);"checked"==Options[e][0]?Options[e][1]=n.checked:Options[e]=n.value}setting.set(Options)}window.onload=function(){setting.get().then(function(e){Options=e,console.log("option from sync storage",e),restoreOptions(e),changeIcon(),getCachedWord()});var e=document.querySelector("#options");e&&(e.onmouseover=function(){this.onmouseover=null,document.getElementById("dict_enable").onclick=function(){saveOptions(),changeIcon()},document.getElementById("ctrl_only").onclick=function(){saveOptions()},document.getElementById("english_only").onclick=function(){saveOptions()},document.getElementById("auto_speech").onclick=function(){saveOptions()},document.getElementById("history_count").onclick=document.getElementById("history_count").onkeyup=function(){saveOptions(),getCachedWord()}}),document.getElementById("word").onkeydown=function(){13==event.keyCode&&mainQuery(document.querySelector("#word").value,translateXML)},document.getElementById("querybutton").onclick=function(){mainQuery(document.querySelector("#word").value,translateXML)},document.querySelector("#backup").onclick=function(){exportHistory()},document.querySelector("#login-youdao").addEventListener("click",function(){chrome.runtime.sendMessage({action:"login-youdao"},function(e){console.log(e)})}),"#popup"===window.location.hash&&document.body.classList.add("popup"),document.body.addEventListener("click",function(e){var n=e.target,t=n.dataset.toggle;"play"===t?playAudio(_word):"addToNote"===t&&addToNote(_word,function(){n.classList.add("green")})})};
